\chapter{Theory}

\section{Modal process rewrite system}

Modal process rewrite systems \cite{BenesK12} are a modal extension of process rewrite systems \cite{Mayr00, Esparza01}.
They induce a modal transition systems \cite{BenesKLS09}.

\section{Basic definitions}

\begin{definition}[Process term]

The set of process terms over a set of constants $Const$
is given by
\begin{mathpar}
  \inferrule{ }{ε ∈ \mc P}\, (0) \hspace{1cm}
  \inferrule{X ∈ Const}{X ∈ \mc P}\, (1) \\
  \inferrule{p ∈ \mc P \\ q ∈ \mc P}{p⋅q ∈ \mc P}\, (S) \hspace{1cm}
  \inferrule{p ∈ \mc P \\ q ∈ \mc P}{p\|q ∈ \mc P}\, (P)
\end{mathpar}
The processes expressions are considered modulo the usual structural congruence, i.e.
the smallest congruence such that the operator $⋅$ is associative,
$\|$ is associative and commutative and
$ε$ is a unit for both $⋅$ and $\|$.
\end{definition}

Processes that can be produced just with rule 0, 1 and S, i.e. contain no $\|$,
are called \emph{sequential processes}
and processes that can be produced just with rule 0, 1 and P, i.e. contain no $⋅$,
are called \emph{parallel processes}

\begin{definition}[Size of a process term]
  The size $|p|$ of a process term $p$ is inductively defined by
  \begin{align*}
    |ε| &= 0 \\
    |X| &= 1 \\
    |p⋅q| &= |p| + |q| \\
    |p \| q| &= |p| + |q|
  \end{align*}
  Process terms will be denoted by lowercase letters $p,q,r,s,t,…$ while single
  constants are denoted by uppercase letters $P,Q,R,S,T,…$.
  %TODO Actions are denoted by $a,b,…$.
\end{definition}

\begin{definition}[Constants of a process term]
  The set of constants $Const(p)$ appearing in a process term $p$ is inductively defined by
  \begin{align*}
    Const(ε) &= ∅ \\
    Const(X) &= \{ X \} \\
    Const(p⋅q) &= Const(p) ∪ Const(q) \\
    Const(p\|q) &= Const(p) ∪ Const(q) \\
  \end{align*}
\end{definition}

\section{Modal transition system}

Modal transition system definition from \cite{BenesK12}:
\begin{definition}[Modal transition system]
A \emph{modal transition system (MTS)} over an action alphabet $Act$ is
a triple $(\mc P, \may[], \must[])$ where $\mc P$ is a set of processes and
$\must[] ⊆ \may[] ⊆ \mc P × Act × \mc P$.
An element $(p,a,q) ∈ \may[]$ is a \emph{may transition}, also written as $p \may[a] q$,
and an element $(p,a,q) ∈ \must[]$ is a \emph{must transition}, also written as $p \must[a] q$.
\end{definition}


\section{Modal process rewrite system}

\begin{definition}[Modal process rewrite system]
A \emph{process rewrite system (PRS)} over a set of constants $Const$ and action
alphabet $Act$ is a finite relation.
$Δ ⊆ \mc P × Act × \mc P$, elements of which are called \emph{rewrite rules}.
A \emph{modal process rewrite system (mPRS)} is a tuple $(\Dmay, \Dmust)$ where
$\Dmay, \Dmust$ are process rewrite systems such that $\Dmay ⊆ \Dmust$.

An mPRS $(\Dmay, \Dmust)$ induces an MTS $(\mc P, \may[], \must[])$ as follows:
\begin{mathpar}
  \inferrule{(p, a, p') ∈ \Dmay}{p \may[a] p'} \, (1) \quad
  \inferrule{(p, a, p') ∈ \Dmust}{p \must[a] p'} \, (2) \\
  \inferrule{p \may[a] p'}{p⋅q \may[a] p⋅q} \, (3) \quad
  \inferrule{p \must[a] p'}{p⋅q \must[a] p'⋅q} \, (4) \quad
  \inferrule{p \may[a] p'}{p\|q \may[a] p\|q} \, (5) \quad
  \inferrule{p \must[a] p'}{p\|q \must[a] p'\|q} \, (6)
\end{mathpar}
\end{definition}

\section{Modal refinement}

\begin{definition}[Refinement]
  Let $(\mc P, \may, \must)$ be an MTS
  and $p,q ∈ \mc P$ be processes.
  We say that $p$ \emph{refines} $q$, written $p ≤_m q$, if there is a relation
  $\mc R ⊆ \mc P × \mc P $ such that
  $(p, q) ∈ \mc R$ and for every $(p, q) ∈ \mc R$ and every $a ∈ Act$:
  \begin{enumerate}
    \item If $p \may[a] p'$ then there is a transition $q \may[a] q'$ s.t.
          $(p',q') ∈ \mc R$.
    \item If $q \must[a] q'$ then there is a transition $p \must[a] p'$ s.t.
          $(p',q') ∈ \mc R$.
  \end{enumerate}
\end{definition}

% modal refinement of two MTS

\section{Attack tree}

\begin{definition}[Attack transition and attack tree]
  Let $(\mc P, \may, \must)$ be an MTS.
  An \emph{attack transition} is a tupel $((p,q), S)$ with $(p,q) ∈ \mc P^2 = \mc P × \mc P$
  and $S ⊆ \mc P$, also written as $(p,q) \attack_a S$.
  For $p,q ∈ \mc P$, the attack transitions are given by
  \begin{mathpar}
    \inferrule{p \may[a] p'}{(p,q) \attack_a \{ (p', q') \mid q \may[a] q' \}}
    \, (1) \hspace{1cm}
    \inferrule{q \must[a] q'}{(p,q) \attack_a \{ (p', q') \mid p \must[a] p' \}}
      \, (2) \\
  \end{mathpar}
  The set of \emph{attack trees} labeled by $(p,q) ∈ \mc P^2$ and $S ⊆ \mc P^2$ is given by
  % TODO update description
  \begin{mathpar}
    \inferrule{p,q ∈ \mc P \\ p \may[a] p'}
      {((p,q, p \may[a] p'), \{ (p',q', q \may[a] q') \mid q \may[a] q' \}, ∅)}
    \, (1) \\
    \inferrule{p,q ∈ \mc P \\ q \must[a] q'}
      {((p,q), q \must[a] q', \{ (p', q', p \must[a] p') \mid p \must[a] p' \}, ∅)}
    \, (2) \\
    \inferrule{((p, q, r), O \uplus (p', q', r'), C) \atree \\ ((p', q', r'), O', C') \atree \\
      (p', q', r') ∈ O}
      {((p, q, r), O, C ∪ \{((p', q', r'), O', C')\}) \atree} \, (3) \\
  \end{mathpar}
  
  The root of an attack tree is $root((p,q,r),O,C) = (p,q)$

  The set of open edges for an attack tree is given by
  $open(((p,q,r), O, C) \atree) = \{(p',q') \mid ∃ r' : (p',q',r') ∈ O\} ∪ ⋃_{T ∈ C} open(T)$.
  A tree $T$ is a \emph{closed tree}, written as $closed(T)$, iff $open(T) = ∅$.  

  %TODO rewrite
  Intuitively, an attack transition $(p,q) \attack_a O$ means that from  
  the state $(p,q)$, there is a sequence of \emph{attack transitions}, that is 
  a may transition from the left side or a must transition from the right side,
  such that $O$ is the set of reachable states by applying
  appropriate \emph{defending transition}, that is a transition of the same type and
  with the same action symbol from the other side.
\end{definition}

\begin{lemma}
  \label{tree-successors}
  For an attack tree $((p,q,r), O, C) \atree$, define the set
  $O \sqcup C = \{ (p',q',r') \mid (p',q',r') ∈ O ∨ ∃ O', C' : ((p',q',r'), O', C') ∈ C \}$.
  If $ r = p \may[a] p$, then there is $p \may[a] p$ and
  $SC = \{ (p',q', q \may[a] q') \mid q \may[a] q' \}$.
  If $r = q \must[a] q'$, then there is $q \must[a] q$ and
  $SC = \{ (p', q', p \must[a] p' \mid p \must[a] p' \}$.
\end{lemma}
\begin{proof}
  % TODO proof
  % TODO attacking transition, defending transition
\end{proof}

\begin{lemma}
  \label{tree-composition}
  For attack trees $T = ((p,q,r), O, C) \atree$ and
  $T' = ((p',q',r'), O', C') \atree$ with $(p',q',r') ∈ open(T)$,
  there exists a tree $T'' = ((p,q,r), O'', C'')$ with
  $open(T'') = (open(T) ∖ \{ (p',q',r') \} ) ∪ open(T')$.
\end{lemma}
\begin{proof}
  % TODO proof
  % TODO attacking transition, defending transition
\end{proof}

\begin{theorem}
  \label{theorem:attack-refinement}
  For an MTS $(\mc P, \may, \must)$ and processes $p,q ∈ \mc P$:
  \[
    (p ≤_m q) \iff ¬∃ T : root(T) = (p,q) ∧ closed(T)
  \]
\end{theorem}

\begin{proof}
    \Rightarrow: Assume $p ≤_m q$. Then there is a refinement relation $\mc R$.
      Let $T = ((p, q, r), O, C) \atree$ be a closed attack tree.
      As $open(T) = \{(p',q') \mid ∃ r' : (p',q',r') ∈ O\} ∪ ⋃_{T'∈C} open(T') = ∅$,
      we have $O = ∅$. and
      therefore $|O \sqcup C| = |C|$.
      We show by induction on $|C|$ that $(p, q) ∉ R$:
      \begin{enumerate}
        \item $|C| = 0$: Then there is an attacking rule $r$, but no
          defending rule, therefore $(p,q) ∉ \mc R$.
        \item $|C| ≥ 0$:
          Then as $open(T) = ⋃_{T'∈C} open(T') = ∅$, we have for
          every $T' = ((p', q', r'), O', C') ∈ C$ that
          $open(T') = ∅$ and by induction hypothesis $(p',q') ∉ \mc R$.
          Then there is an attacking rule $r$, but for every defending rule $r'$
          % TODO use lemma
          leading to $(p',q')$ we have $(p',q') ∈ \mc R$, therefore $(p,q) ∉ \mc R$.
      \end{enumerate}
      So for $(p,q)$ there is no attack tree.
    \Leftarrow: Assume $¬∃ T : root(T) = (p,q) ∧ closed(T)$
      We show that $\mc R := \{ (p,q) \mid ¬∃ T : root(T) = (p,q) ∧ closed(T) \}$ is a valid
      refinement relation. First $(p,q) ∈ \mc R$, and for any $(p,q) ∈ \mc R$:
      
      If the attacking rule is $r$, then by
      by inference rule 1 or 2 there exists $T = ((p,q,r), O, C) \atree$.
      From all such $T$, choose the one where $O$ is minimal
      with regard to the inclusion order.
      There exists $(p',q',r') ∈ O : (p',q') ∈ \mc R$, because otherwise
      there would be a closed attack tree $T' = ((p',q', r'), O', C') \atree$ and
      with this tree by inference rule 3 we would get % TODO use lemma
      $((p,q,r), O'' ∖ \{(p',q',r')\}, C ∪ T') $
      with $O'' = O ∖ \{(p',q',r')\} ⊊ O$ in contradiction to the minimality of $O$.
      So for the attack rule $r$ there is a defending rule $r'$ leading to
      $(p',q') ∈ \mc R$.
      
      With this refinement relation we have $p ≤_m q$.
\end{proof}

\section{Visibly pushdown automaton}

\begin{definition}[Visibly pushdown automaton]
A PRS is a visibly pushdown automaton (vPDA) if
all processes are sequential and there is a partition
$Act = Act_r \uplus Act_i \uplus Act_c$
such that each rule $(p, a, p') ∈ Δ$ has the form
\begin{align*}
  p &= P⋅S
  & &\text{and} &
  p' &= \begin{cases}
  Q & \text{if } a ∈ Act_r \quad \text{(return rule)}\\
  Q⋅T & \text{if } a ∈ Act_i \quad \text{(internal rule)} \\
  Q⋅T⋅R & \text{if } a ∈ Act_c \quad \text{(call rule)}
\end{cases}
\end{align*}
The modal extension for a \emph{modal visibly pushdown automaton (mvPDA)} is straightforward.
\end{definition}

\begin{definition}[Attack rules for mvPDA]
  Let $(\Dmay, \Dmust)$ be an mvPDA.
  We define a \emph{attack rules} $(p,q) \attack_b S$  obtainable from the rewrite rules.
  For every $p,q ∈ \mc P$, we have:
  \begin{mathpar}
    \inferrule{(p, a, p') ∈ \Dmay}{(p,q) \attack_b \{ (p', q') \mid (q, a, q') ∈ \Dmay \}}
      \, (1) \\
    \inferrule{(q, a, q') ∈ \Dmust}{(p,q) \attack_b \{ (p', q') \mid (p, a, p') ∈ \Dmust \}}
      \, (2) \\
    \inferrule{(p,q) \attack_b \{(p'⋅P,q'⋅Q)\} \uplus S \\ (p',q') \attack_b S' \\
      ∀(p'',q'') ∈ S' : |p''| = 1 }
      {(p,q) \attack_b S ∪ \{  (p''⋅P, q''⋅Q) \mid (p'',q'') ∈ S' \}} \, (3) \\
    \inferrule{(p,q) \attack_b \{(p',q')\} \uplus S \\ (p',q') \attack_b S' \\
      ∀(p'',q'') ∈ S' : |p''| = 1 }
      { (p,q) \attack_b S ∪ S'} \, (4)
  \end{mathpar}

  Due to the conditions on the rewrite rules of an mvPDA and the construction of the
  attack rules, we can see
  that for any element $(p,q) \attack_b S$ it holds that
  $|p| = |q| = 2$ and for any $(p',q') ∈ S$ that $1 ≤ |p'| = |q'| ≤ 3$.
  
  Then we see that rules 3 and 4 always combine a rule where on the left-hand side,
  there is $(p',q')$ in $S$ with $|p'| = 2$ or $|p'|$ = 3, while on the right-hand side
  we require for all $(p'',q'') ∈ S'$ that $|p''| = 1$. Therefore we will call
  an attack rule $(p,q) \attack_b S$ a \emph{right-hand side} rule if
  $∀(p',q') ∈ S: |p'| = 1$ and otherwise a \emph{left-hand side} rule.
\end{definition}

\begin{lemma}
  \label{lemma:tree-lift}
  Given an MTS generated by a mvPDA,
  for an attack tree $((p, q, r), O, C) \atree$ with
  $open(T) = S$ and any $s,t ∈ \mc P$, there is also a tree
  $T' = ((p⋅s, q⋅t, r'), O', C') \atree$ with
  $open(T') = \{ (p'⋅s,q'⋅t,r'') \mid (p', q', r') ∈ open(T) \}$. %TODO r''
\end{lemma}
\begin{proof}
  % TODO prove
  By the MTS induction rules, we have that for
  every $p \may[a] p'$ is generated from a $(p, a, p') ∈ \Dmay$
  and for a mvPDA therefore $|p| = 2$. Then there is only one transition from $p⋅s$,
  nameley $p⋅s \may[a] p'⋅s$ generated by the MTS induction rule 1.
  Also for every $q \must[a] q'$ there is just $q⋅t \may[a] q'⋅t$ from $q⋅t$.
  
      Then it is a single transition created from $p \may[a] p'$
      with $S = \{ (p', q') \mid q \may[a] q' \}$ and we get
      $p⋅s \may[a] p'⋅s$ and $\{ (p'⋅s, q'⋅t) \mid q⋅t \may[a] q'⋅t \} = S'$.
      If the transition was created from $q \must[a] q'$
      with $S = \{ (p', q') \mid p \must[a] p' \}$ and we get
      $\{ (p'⋅s, q'⋅t) \mid p⋅t \must[a] p'⋅t \} = S'$
      Both cases yield $(p⋅s,q⋅t) \attack_a^* S'$.
\end{proof}

\begin{theorem}
  For an mvPDA $(\Dmay, \Dmust)$ with its induced MTS $(\mc P, \may[], \must[])$,
  it holds that for any $P,S,Q,R ∈ Const$:
  \[
    ∃ T : root(T) = (P⋅S,Q⋅R) ∧ closed(T) \iff (P⋅S,Q⋅T) \attack_b ∅
  \]
\end{theorem}
\begin{proof}
    \Rightarrow: Assume $T$ to be closed tree with $root(T) = (P⋅S,Q⋅T)$.
    
      the linear form of a derivation of the attack sequence. Always
      $a_1$ has the form $(P⋅S, Q⋅R) \attack_a S$ and $a_n$ the form
      $(p,q) \attack_a ∅$.

      Our proposition is that if we can split up the sequence into subsequences
      which we can all compute seperately, we can also compute the whole sequence.
      More formally, we want to show that if there is a
      set of $k+1$ indices $I = {i_0,…,i_k}$ where
      \begin{enumerate}
        \item $0 = i_0 < i_1 < i_2 < … < i_{k-1} < i_k = n$.
        \item There is a sequence $(b_1, …, b_k)$ where
          each $b_i$ is an attack rule $(p,q) \attack_b S$.
        \item For every $i,j ∈ I$ with $i<j$ the sequence $(a_{i+1},…,a_j)$, which
          generates the attack sequence $(p,q) \attack_a^* S$, the representing rule
          $b_j$ is $(p,q) \attack_b S$
          If $j < n$ then with $b_i = (p',q') \attack_b S'$ we require $(p',q') ∈ S'$.
          and if $j = n$ then $S = ∅$.
      \end{enumerate}
      there is $(P⋅S,Q⋅T) \attack_b ∅$.

      We prove this by induction on the number $k$:

      \begin{enumerate}
        \item $k=1$: Then the indices are $0, n$ and the rule sequence $(b_1)$
          represents $(a_1, …, a_n)$ generating $(P⋅S, Q⋅T) \attack_a^* ∅$.
          Then we have $(P⋅S, Q⋅T) \attack_b ∅$.
        \item $k > 1$, and the induction hypothesis holds for any $k' < k$:
          Let $(b_1, …, b_k)$ be the rule sequence.
          For the first rule $b_1 = (P⋅S,Q⋅T) \attack_b S$, there
          is be $(p',q') ∈ S$ with $|p'| = |q'| ≥ 2$ because otherwise no more rules
          could be applied afterwards, in contradiction to $k > 1$.
          So this is a left-hand side rule.
          Also the last rule $b_k = (p',q') \attack_b ∅$ is a right-hand side rule.
          %
      \end{enumerate}
    \Leftarrow:
      We show that for $(p,q) \attack_b S$, there is a tree
      $T = ((p,q,r), O, C) \atree)$ such that
      $open(T) = S$.
      %$\{∃ r' : (p', q',r') ∈ open(T)\} = S$.
      by induction on the inference of
      $(p,q) \attack_b S$:
      \begin{enumerate}
        \item If it was created by rule 1 or 2.
          If it was created from $(p, a, p') ∈ \Dmay$, then there is
          an attacking transition $r = p \may[a] p'$ and 
          for every $(q, a, q') ∈ \Dmay$ there is one induced defending transition
          $r' = q \may[a] q'$.
          If it was created from $(q, a, q') ∈ \Dmust$, then there is
          an attacking transition $r = p \may[a] p'$ and 
          for every $(q, a, q') ∈ \Dmay$ there is one induced defending transition
          $r' = q \may[a] q'$.

          Therefore
          $states(def(p, q, r)) = S$
          and get the tree $T = ((p, q, r), def(p, q, r), ∅) \atree$ with
          $open(T) = S$.
        \item It was created by rule 3 from $(p,q) \attack_b \{(p'⋅P,q'⋅Q)\} \uplus S''$ and
          $(p',q') \attack_b S'$ with $S = S'' ∪ S'''$ and
          $S''' = \{  (p''⋅P, q''⋅Q) \mid (p'',q'') ∈ S' \}$.
          Then by induction hypothesis there is a tree $T' = ((p'⋅P,q'⋅Q,r'),O',C') \atree$
          with $open(T') = S'$ and a tree $T'' = ((p,q,r),O,C) \atree$
          with $open(T'') = S'' \uplus \{(p'⋅P,q'⋅Q,r')\}$. %TODO include r'
          By lemma \ref{lemma:tree-lift} there is also a tree
          $T''' = ((p⋅P,q⋅Q,r'),O'',C'') \atree$
          with $open(T''') = O''' \uplus \{(p'⋅P,q'⋅Q,r'')\}$ and %TODO include r', update r''
          $O''' = \{  (p''⋅P, q''⋅Q, r''') \mid (p'',q'', r'') ∈ S' \} = S'''$. % update r'''
          By lemma \ref{tree-composition} we then get a tree
          $T = ((p,q,r), O'''', C'''')$ with $open(T) = S'' ∪ S''' = S$.
        \item It was created by rule 4 from $(p,q) \attack_b \{(p',q')\} \uplus S''$ and
          $(p',q') \attack_b S'$ with $S = S'' ∪ S'$.
          Then by induction hypothesis there is a tree $T' = ((p',q',r'),O',C') \atree$
          with $open(T') = S'$ and a tree $T'' = ((p,q,r),O,C) \atree$
          with $open(T'') = S'' \uplus \{(p',q')\}$. %TODO include r'
          By lemma \ref{tree-composition} we then get a tree
          $T = ((p,q,r), O'', C'')$ with $open(T) = S'' ∪ S' = S$.
      \end{enumerate}
      Then if $(P⋅S,Q⋅T) \attack_b ∅$ we have a tree $T = (P⋅S,Q⋅T, r), O, C)$ with
      $open(T) = ∅$.
\end{proof}

% theory and background

